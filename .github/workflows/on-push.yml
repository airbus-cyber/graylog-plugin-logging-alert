name: Continuous Integration
on: [push]
jobs:
  build:
    runs-on: ubuntu-20.04
    steps:
      - name: Check out repository code
        uses: actions/checkout@v2
        with:
          path: graylog-plugin-logging-alert
      - id: getVersions
        run: |
          cd graylog-plugin-logging-alert
          GRAYLOG_VERSION = $( mvn help:evaluation -Dexpression=project.parent.version -q -DforceStdout )
          echo "::set-output name=graylogVersion::$GRAYLOG_VERSION"
      - name: Setup Java JDK 8
        uses: actions/setup-java@v2
        with:
          java-version: 8
          distribution: temurin
          cache: maven
      - uses: actions/cache@v2
        id: cache
        with:
          path: graylog2-server
          key: ${{ steps.getVersions.outputs.graylogVersion }}
      - name: Check out Graylog
        if: steps.cache.outputs.cache-hit != 'true'
        uses: actions/checkout@v2
        with:
          repository: Graylog2/graylog2-server
          ref: ${{ steps.getVersions.outputs.graylogVersion }}
          path: graylog2-server
      - name: Build Graylog
        if: steps.cache.outputs.cache-hit != 'true'
        run: |
          cd graylog2-server
          mvn compile -DskipTests=true --batch-mode
      - name: Build plugin
        run: |
          cd graylog-plugin-logging-alert
          mvn package --batch-mode
      - name: Archive jar
        uses: actions/upload-artifact@v2
        with:
          name: jar
          # TODO should upload only the jar with its full name (get the version number from the pom.xml)
          path: graylog-plugin-logging-alert/target/*.jar
