name: Continuous Integration
on: [push]
jobs:
  build:
    runs-on: ubuntu-20.04
    steps:
      - name: Check out repository code
        uses: actions/checkout@v2
        with:
          path: graylog-plugin-logging-alert
      - name: Check out Graylog
        uses: actions/checkout@v2
        with:
          repository: Graylog2/graylog2-server
          # TODO SSOT: should extract the version of graylog2-server from the pom.xml
          ref: 4.1
          path: graylog2-server
      - name: Setup Java JDK 8
        uses: actions/setup-java@v2
        with:
          java-version: 8
          distribution: temurin
          cache: maven
      # TODO should cache the result of building graylog2-server, it would increase build speed
      - name: Build Graylog
        run: |
          cd graylog2-server
          mvn compile -DskipTests=true --batch-mode
      - name: Build plugin
        run: |
          cd graylog-plugin-logging-alert
          mvn package --batch-mode
      - name: Archive jar
        uses: actions/upload-artifact@v2
        with:
          name: jar
          # TODO should upload only the jar with its full name (get the version number from the pom.xml)
          path: graylog-plugin-logging-alert/target/*.jar
